---
import * as MediaUtils from "@lib/MediaUtils";
import { type ImageMetadata } from "astro";
import DaisyLightbox from "@components/DaisyLightbox.astro";

export interface MediaInfo {
  collection?: string;
  folder?: string;
  fileName?: string | null;
}

interface Props {
  mediaInfo: MediaInfo;
  fallbackMedia?: ImageMetadata;
  alt?: string;
  class?: string;
  useLightbox?: boolean;
  lightboxClass?: string;
}

const {
  mediaInfo,
  fallbackMedia,
  alt,
  class: className,
  useLightbox = false,
  lightboxClass,
} = Astro.props;

async function getCollectionMedia(
  mediaInfo: MediaInfo,
): Promise<ImageMetadata | undefined> {
  if (mediaInfo.collection && mediaInfo.folder && mediaInfo.fileName) {
    const mediaSource = MediaUtils.getMediaSource(mediaInfo.collection);
    if (mediaSource) {
      return await MediaUtils.loadSingleMedia(
        mediaSource,
        mediaInfo.folder,
        mediaInfo.fileName,
      );
    }
  }

  return;
}

const media = (await getCollectionMedia(mediaInfo)) ?? fallbackMedia;
---

{
  media &&
    ((useLightbox && (
      <DaisyLightbox
        src={media.src}
        alt={alt}
        imgClass={className}
        lightboxImgClass={lightboxClass}
      />
    )) ||
      (!useLightbox && <img src={media.src} alt={alt} class={className} />))
}
{!media && <slot name="fallbackContent" />}
