---
import ModalDialog from "@components/ModalDialog.astro";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import * as PathUtils from "@lib/PathUtils";
import * as EntryUtils from "@lib/EntryUtils";

interface Props {
  headerText?: string;
  entry: EntryUtils.Entry;
  fileNames?: string[];
}

interface GalleryMediaInfo {
  media: ImageMetadata;
  caption: string;
}

const { headerText, entry, fileNames } = Astro.props;

function sortByFileNameList(
  media: GalleryMediaInfo[],
  fileNames: string[],
): GalleryMediaInfo[] {
  let temp: { media: EntryUtils.EntryImage; caption: string }[] = [];
  for (const fn of fileNames) {
    let m = media.findIndex(
      (v, _) =>
        PathUtils.getFileNameFromPath(v.media.src)
          .toLocaleLowerCase()
          .localeCompare(fn) == 0,
    );
    if (m >= 0) {
      temp.push(media[m]);
    }
  }

  return temp;
}

let media: GalleryMediaInfo[] | undefined;
if (entry.galleryImages) {
  media = entry.galleryImages.map((gi) => ({
    caption: gi[0],
    media: gi[1],
  }));

  if (fileNames && fileNames.length > 0) {
    media = sortByFileNameList(media, fileNames);
  }
}

const galleryKey = Math.random().toString(16).slice(2);
---

{media && headerText && <h2 class="mb-0">{headerText}</h2>}
{/* gallery preview images */}
{
  media && (
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-12 mt-0">
      {media!.map((m, slideNumber) => (
        <div
          id={`gallery${galleryKey}_trigger${slideNumber}`}
          class="h-40 max-w-full sm:max-w-1/2 md:max-w-1/3 lg:max-w-1/4"
        >
          <Image
            src={m.media}
            alt={m.caption}
            class="h-full w-full object-cover object-center rounded-box cursor-pointer"
          />
        </div>
      ))}
    </div>
  )
}
{/* modal dialog */}
{
  media && (
    <ModalDialog
      id={`gallery${galleryKey}`}
      widthClass="w-[95vw]"
      heightClass="h-[90vh]"
    >
      {/* carousel */}
      <div id={`carousel${galleryKey}`} class="relative size-full">
        {/* carousel wrapper */}
        <div class="relative size-full overflow-hidden rounded-box">
          {/* items */}
          {media.map((m, slideNumber) => (
            <div
              id={`carousel${galleryKey}_item${slideNumber}`}
              class="size-full flex flex-col hidden duration-700 ease-in-out"
            >
              <div class="w-full h-12 mb-2 shrink-0 relative">
                <span class="text-2xl text-bold absolute bottom-0 mb-1">
                  {m.caption}
                </span>
              </div>
              <div class="size-full content-center overflow-auto rounded-box">
                <Image
                  src={m.media}
                  alt={m.caption}
                  class="m-0 w-full h-auto rounded-box"
                />
              </div>
            </div>
          ))}
        </div>
        {/* indicators */}
        <div class="absolute z-30 flex -translate-x-1/2 space-x-3 rtl:space-x-reverse bottom-6 left-1/2">
          {media.map((m, slideNumber) => (
            <button
              id={`carousel${galleryKey}_ind${slideNumber}`}
              type="button"
              class="w-4 h-4 rounded-box"
              aria-current={slideNumber == 0}
              aria-label={`Slide ${slideNumber + 1}`}
              data-carousel-slide-to={slideNumber}
            />
          ))}
        </div>
        {/* controls */}
        <button
          id={`carousel${galleryKey}_prev`}
          type="button"
          class="absolute top-14 bottom-0 left-0 z-30 flex items-center justify-center px-4 cursor-pointer focus:outline-none hover:glass rounded-l-box"
          data-carousel-prev
        >
          <Icon name="carousel_prev" class="w-12 h-12 text-base-content" />
        </button>
        <button
          id={`carousel${galleryKey}_next`}
          type="button"
          class="absolute top-14 bottom-0 right-0 z-30 flex items-center justify-center px-4 cursor-pointer focus:outline-none hover:glass rounded-r-box"
          data-carousel-next
        >
          <Icon name="carousel_next" class="w-12 h-12 text-base-content" />
        </button>
      </div>
    </ModalDialog>
  )
}
{/* initialization */}
{
  media && (
    <script
      is:inline
      type="module"
      define:vars={{ galleryKey, itemCount: media.length }}
    >
      import initLightboxGallery from "../src/lib/initLightboxGallery";
      initLightboxGallery(galleryKey, itemCount);
    </script>
  )
}
